#{extends 'main.html' /}
#{set title:'PaymentFlow' /}

#{set isAgencyHeader: true /}


<style>
.info-card{
    display: inline-block;
    vertical-align: middle;
}
</style>
<section class="bg-path">
    <article class="container-fluid">
        <div class="row">
            <ul class="general-path">
                <li>
                    <span class="circle-path icon-checked-path"></span>
                    <span class="name-path">búsqueda</span>
                </li>
                <li class="line-path">
                    <span class="circle-path bg-circle-path">2</span>
                    <span class="name-path">pasajeros</span>
                </li>
                <li>
                    <span class="circle-path">3</span>
                    <span class="name-path">pago</span>
                </li>
            </ul>
        </div>
    </article>
</section>

#{if state!=null}
                        <div class="alert alert-info" style="display: inline-block; width: 100%;">
                            <div class="info-card">
                                <img src="../public/images/icon-card.svg" alt="imagen tarjeta" />
                            </div>
                            <div class="info-card" id="panelazul" style="max-width: 90%;">
								<b> ${state.clientName}, tu saldo de dólares Dólares-Premio disponible a la fecha es de <span class="light-blue">${state.clientDp}</span> </b>
                            </div>
                            
                       </div>
#{/if}

                       
                       
                       
<section class="search-arrive payment-path">
    <form id="checkoutForm" action="javascript:void(0);" method="post">
        <article class="container-fluid">
            <div class="row">
                <h2>¿Quién Viaja?</h2>
                <p class="info-help">En caso de necesitar ayuda comunicarse al correo <strong>ventaonline@travelclub.cl</strong></p>
                <div class="col-md-8">
                    %{ int passengersCount = 0; }%
                    %{ int passengersNumber = 1; }%
                    #{list bfmResultItem.pricing.detail, as:'pricingDetails'}
                        #{list items:1..pricingDetails.quantity.getAsInt(), as:'i'}
                            #{checkout.passengerBox key: passengersCount, passengerNumber: passengersNumber+".1", passengerType: pricingDetails.code.getAsString(), countriesList:countriesList, onlyPassport:onlyPassport /}
                            %{ passengersCount++; }%
                            %{ passengersNumber++; }%
                        #{/list}
                    #{/list}
                    #{checkout.contactBox/}
                    *{#{checkout.paymentBox/}}*
                    #{checkout.termsConditionBox/}
                    #{checkout.hiddenInputBox bfmResultItem: bfmResultItem, promotion: promotionDto/}
                </div>
                <div class="col-md-4">
                    #{checkout.flightBox bfmResultItem:bfmResultItem/}
                    #{checkout.summaryBox pricing:bfmResultItem.pricing, pricingCLP:bfmResultItem.pricingCLP, selectedCurrency:selectedCurrency/}
                    #{checkout.airRules airRulesResultList:airRulesResultList/}
                </div>
            </div>
            <div class="row">
                <div class="col-md-8 text-right">
                    <input type="submit" name="submitButton" class="btn btn-search" value="continuar" id="btnContinue">
                </div>
            </div>
        </article>
    </form>
</section>

#{spinnerModal/}


<!-- Modal -->
<div class="modal fade" id="modalLogin" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-body" id="loginModalBody" style="height:400px; overflow: hidden;">
      </div>

    </div>
  </div>
</div>



#{set 'scriptFiles'}
#{get 'scriptFiles' /}
#{checkout/checkoutScript token:token,transactionId:transactionId, promotionDto:promotionDto, selectedCurrency:selectedCurrency /}



<script type="text/javascript">
	function numberWithCommas(x) {
		return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
	}

	$(function () {

		var selectedCurrency = "${selectedCurrency}";
		$( ".clppriceCon" ).each(function( index ) {
				$(this).html(numberWithCommas($(this).html()));
			});	
// 		if (selectedCurrency=="clp"){
// 			$( ".usdpriceCon" ).each(function( index ) {
// 				var exchangeRate = parseFloat("${dollarExchangeRate}");
// 				var numToChange = parseFloat($(this).html());
// 				$(this).html(numberWithCommas(parseFloat(numToChange * exchangeRate).toFixed(0)));
// 			});	
// 			$( ".simbolCurrency" ).each(function( index ) {
// 				$(this).html("$");
// 			});	
// 			$( ".clppriceCon" ).each(function( index ) {
// 				$(this).html(numberWithCommas($(this).html()));
// 			});	
// 		}


	    #{if state==null}
	    	$('#loginDiv').show();
	        $( "#btnLoginTrUser" ).click(function( event ) {
	            var agencyId ="${promotionDto.agency.externalId}";
	            var transactionId = "${transactionId}";
	            var agencySlug = "${promotionDto.agency.slug}";
	            var selectedCurrency = "clp";
	            var step = 'index';
	           // window.history.pushState("", "", window.location.href+transactionId);

	            $('<iframe src="/auth/'+transactionId+'/'+selectedCurrency+'/'+agencyId+'/'+agencySlug+'/'+step+'" frameborder="0" style="padding-left: 50px; position: relative; top: -100px;" width="500" height="500" scrolling="no" id="myFrame"></iframe>').appendTo('#loginModalBody');
	            $('#modalLogin').modal('show');
	        });
		#{/if}
		#{else}
    	    $("#loginDiv").hide();
    	    $('#loggedDiv').show();
    	    $('#loggedDiv').html("${state.clientName}");
    	    document.cookie = "tokenVuelos=${state.appToken}";
    	#{/else}
	});

</script>


#{/set}

#{modalNeadHelp /}
#{modalExpiredSession /}

#{set isAgencyFooter: true /}

