

<button class="btn btn-primary btn-search-mobile" type="button" data-toggle="collapse"
        data-target="#collapseSearchMobile" aria-expanded="false" aria-controls="collapseSearchMobile">
    <ul>
        <li><i class="icon-fly-mobile-search"></i><span class="txt-fly-mobile">eze - lon</span></li>
        <li><i class="icon-calendar-mobile-search"></i><span class="txt-calendar-mobile">Sábado 8 de Abr - Domingo 23 Abr</span>
        </li>
        <li><i class="icon-passenger-mobile-search"></i><span class="txt-passenger-mobile">1</span></li>
    </ul>
</button>
<div class="collapse" id="collapseSearchMobile">
    <div class="well">
        <div class="bg-search">
            <form id="flightSearchForm" class="form-search-travel" action="" method="">
                <div class="form-group col-md-12">
                    <label>Origen:</label>
                    <select name="origenSlc" class="form-control" id="origin" > </select>
                    <input type="hidden" name="origen" id="originHdn" /> 
                </div>
                <div class="form-group col-md-12">
                    <label>Destino:</label>
                    <select  name="destinoSlc" class="form-control" id="destiny"> </select>
                    <input type="hidden" name="destino" id="destinyHdn" />
                </div>
                <div class="form-group col-xs-6">
                    <label>Partida:</label>
                    	<div class='input-group date' id='starDateBtn'>
                            <input type="text" name="partida" autocomplete="off" id="startDate"
                                   class="form-control"  style="border-right: 0; padding-right: 0;">
        					<i class="bg-calendar input-group-addon"></i>
                        </div>
                </div>
                <div class="form-group col-xs-6">
                    <label>Regreso:</label>
                    <div class='input-group date' id='endDateBtn'>
                        <input type="text" name="regreso" id="endDate" autocomplete="off"
                               class="form-control" value="${endDate}"
                               style="border-right: 0; padding-right: 0;">
    					<i class="bg-calendar input-group-addon"></i>
    					</span>
                    </div>
                </div>
                <div class="form-group col-xs-4">
                    <label>Adultos:</label>
                    <select id="adultCount" class="bg-arrow form-control" name="adultcount">
                        <option>1</option>
                        <option>2</option>
                        <option>3</option>
                        <option>4</option>
                        <option>5</option>
                        <option>6</option>
                        <option>7</option>
                    </select>
                    <span>(12 ó + años)</span>
                </div>
                <div class="form-group col-xs-4">
                    <label>Niños:</label>
                    <select id="childrenCount" class="bg-arrow form-control" name="childrencount">
                    	<option>0</option>
                        <option>1</option>
                        <option>2</option>
                        <option>3</option>
                        <option>4</option>
                    </select>
                    <span>(2 a 11 años)</span>
                </div>
                <div class="form-group col-xs-4">
                    <label>Infantes:</label>
                    <select id="infantCount" class="bg-arrow form-control" name="infantcount">
                        <option>0</option>
                        <option>1</option>
                        <option>2</option>
                        <option>3</option>
                        <option>4</option>
                    </select>
                    <span>(0 a 23 meses)</span>
                </div>
                <div class="col-md-12 text-center">
                    <input type="submit" value="Buscar Vuelos" class="btn btn-search">
                </div>
            #{set 'moreScripts'}
            #{get 'moreScripts' /}
                $(document).ready(function() {

var loadFlightData = (function() {

            if ($('#adultCount').val()*2<parseInt($('#childrenCount').val())+parseInt($('#infantCount').val())){
              alert("La cantidad de niños e infantes tiene un máximo de dos por adulto.");
              return false;
            }
                        $( "#loading_departure_city").html($(this).find('input[name="origen"]').val());
                        $( "#loading_return_city").html($(this).find('input[name="destino"]').val());

                        $( "#loading" ).show("fade");
                        $( "#priceSuggestionMatrix" ).html("");
                        $( "#fligthsData" ).html("");

                        $( "#priceSuggestionMatrix" ).load(
                            "/flights/matrix?" + getPriceSuggestionMatrixParams(),
                            function (responseText, textStatus, XMLHttpRequest) {
                                if (textStatus == "success") {
                                    $( "#priceSuggestionMatrix" ).show("slow");
                                    onReadyMatrix();
                                }
                            }
                        );
                        $( "#fligthsData" ).load(
                            "/flights/data?" + getSearchParams(),
                            function (responseText, textStatus, XMLHttpRequest) {
                                if (textStatus == "success") {
                                    $( "#loading" ).hide();
                                    $( "#fligthsData" ).show("slow");
                                    if(!$( "#filterContent" ).html().length) {
                                        $( "#filterContent" ).html($( "#filterResult" ).html());
                                        onReadyFilters();
                                    }
                                }
                            }
                        );

                        
                    });

                    $("#flightSearchForm").submit(function(event){
                      event.preventDefault();
                      loadFlightData();
                    });


              function onReadyMatrix(){
                    $('a.pr-fare').click(function(e){
                      e.preventDefault();

                      $("#startDate").val($(this).data('from'));
                      $("#endDate").val($(this).data('to'));
                      $("#flightSearchForm").submit();

                  });
              }

                                      
                   
                    $("#origin, #destiny").select2({
						  ajax: {
						    url: "@@{SearchController.getAutoComplete}",
						    dataType: 'json',
						    delay: 250,
						    language: "es",
						    data: function (params) {
						      return {
						        q: params.term, // search term
						        page: params.page
						      };
						    },
						    processResults: function (data, params) {
						      params.page = params.page || 1;
						
						      return {
						        results: data.items,
						        pagination: {
						          more: (params.page * 30) < data.total_count
						        }
						      };
						    },
						    cache: true
						  },
						  escapeMarkup: function (markup) { return markup; }, // let our custom formatter work
						  minimumInputLength: 1,
						  templateResult: formatRepo,
						  templateSelection: formatRepoSelection
					  }).on("change", function(e) {
					  		if (this.id=='origin') {
					  			$('#originHdn').val($('#origin').select2('data')[0].id);
					  		}
					  		else {
					  			$('#destinyHdn').val($('#destiny').select2('data')[0].id);
					  		}
				        });
 });
 
                    

			  var dateFormat = "dd/mm/yy";
              var minDate = new Date(parseDate("18/12/2016"));
              var maxDate = new Date(parseDate("09/10/2017"));

              jQuery(function($) {
                if (jQuery().datepicker) {
                  $.datepicker.regional['es'] = {
                      prevText: '',
                      nextText: '',
                      currentText: 'Hoy',
                      monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
                      monthNamesShort: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
                      dayNames: ['Domingo', 'Lunes', 'Martes', 'Mi&eacute;rcoles', 'Jueves', 'Viernes', 'S&aacute;bado'],
                      dayNamesShort: ['Dom', 'Lun', 'Mar', 'Mi&eacute;', 'Juv', 'Vie', 'S&aacute;b'],
                      dayNamesMin: ['Do', 'Lu', 'Ma', 'Mi', 'Ju', 'Vi', 'S&aacute;'],
                      weekHeader: 'Sm',
                      firstDay: 1,
                      isRTL: false,
                      showMonthAfterYear: false,
                      numberOfMonths: 2,
                      dateFormat: dateFormat,
                      yearSuffix: "",
                      beforeShowDay: highlightDates
                    };
                  $.datepicker.setDefaults($.datepicker.regional['es']);
                }
              });
              function parseDate(str) {
                  var mdy = str.split('/')
                  return new Date(parseInt(mdy[2], 10), (parseInt(mdy[1], 10) - 1), parseInt(mdy[0], 10));
              }
              String.prototype.replaceAll = function(search, replacement) {
                  var target = this;
                  return target.replace(new RegExp(search, 'g'), replacement);
              }
              function toSlash(str) {
                return str.replaceAll("-","/");
              }
              function toHyphen(str) {
                return str.replaceAll("/","-");
              }

                $( "#starDateBtn" ).click(function() {
                    $("#startDate").datepicker('show')
                });

                $( "#endDateBtn" ).click(function() {
                    $("#endDate").datepicker('show')
                });

                function getDate( element ) {
                    var date;
                    try {
                        date = new Date(parseDate(element.val()));
                    } catch( error ) {
                        date = null;
                    }
                    return date;
                }

                function highlightDates(date) {
                    var currentStartDate = getDate($("#startDate"));
                    var currentEndDate = getDate($("#endDate"));

                    if (date.getTime() === currentStartDate.getTime()) {
                        return [true, "ui-datepicker-departure", ''];
                    } else if (date.getTime()  === currentEndDate.getTime()) {
                        return [true, "ui-datepicker-return", ''];
                    } else if ( date < currentEndDate) {
                        if (date > currentStartDate) {
                            return [true, "ui-datepicker-range", ''];
                        } else {
                            return [true, '', ''];
                        }
                    } else {
                        return [true, '', ''];
                    }
                }



              $(function() {
                $("#startDate").datepicker({
                  minDate: 5,
                  maxDate: 300,
                  onClose: function(){
                    $("#endDate").datepicker("show");
                  }
                }).on( "change", function() {
                  var currentStartDate = getDate($("#startDate"));

                  var min = $(this).datepicker("getDate") || new Date();
                  min.setDate(min.getDate() + 1);
                  if(currentStartDate <= minDate){
                    $("#endDate").datepicker( "option", "minDate", minDate );
                    $("#endDate").datepicker( "option", "maxDate", maxDate );
                  }
                  if(currentStartDate > minDate){
                    $("#endDate").datepicker( "option", "minDate", currentStartDate );
                  }
                  //$("#endDate").datepicker("show");

                });
                $( "#departureDate" ).datepicker( "setDate", "" );
              });
              

              $(function() {
                $( "#endDate" ).datepicker({
                  minDate: 5,
                  maxDate: 300,
                }).on( "change", function() {
                  var currentEndDate = getDate($("#endDate"));
                  if(currentEndDate <= maxDate){
                    $("#departureDate").datepicker( "option", "minDate", minDate );
                    $("#departureDate").datepicker( "option", "maxDate", currentEndDate );
                  }
                });
                $( "#endDate" ).datepicker( "setDate", "" );
              });

            #{/set}
            </form>
        </div>

    </div>

</div>

#{set 'moreScripts'}
    #{get 'moreScripts' /}
 
 var queryResults;
 

    var tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);

    var tomorrow2 = (new Date()).setDate(tomorrow.getDate() + 1);
    
    
 
 function markMatch(text, markup) {
    markup.push("<span class='select2-matched'>");
    markup.push(text);
    markup.push("</span>");
}


    function formatRepoSelection (place) {
      return place.city;
    }
    
     function formatRepo (place) {
      var markup=[];
      if (!place)return place;
      markMatch(place.name + " (" + place.id + ")", markup);
      return markup.join("");
    }
    
    
    
 
function getPriceSuggestionMatrixParams() {
    var searchForm = $("#flightSearchForm");
    return $.param({
        origin: searchForm.find('input[name="origen"]').val(),
        destination: searchForm.find('input[name="destino"]').val(),
        departuredate: searchForm.find('input[name="partida"]').val(),
        returndate: searchForm.find('input[name="regreso"]').val(),
        passengercount: searchForm.find('select[name="adultcount"]').val(),
    });
}

function getSearchParams() {
    var searchForm = $("#flightSearchForm");
    var filterForm = $("#filterResultForm");
    return $.param({
        origin: searchForm.find('input[name="origen"]').val(),
        destination: searchForm.find('input[name="destino"]').val(),
        departuredate: searchForm.find('input[name="partida"]').val(),
        returndate: searchForm.find('input[name="regreso"]').val(),
        adultcount: searchForm.find('select[name="adultcount"]').val(),
        childrencount: searchForm.find('select[name="childrencount"]').val(),
        infantcount: searchForm.find('select[name="infantcount"]').val()
    });
}

function addActiveFilter(description) {
    $(".active-filter").append('<div class="box-active-filter"><span class="txt-filter-activer">' + text + '</span><i class="icon-close-filter"></i></div> ');
}

function deleteActiveFilter(obj) {
    obj.remove();
}


function onReadyFilters() {

    /*FILTER*/

    var priceRangeSliderStartLabel = $('.price-range-slider-start-label');
    var priceRangeSliderEndLabel = $('.price-range-slider-end-label');
    var timeRangeSliderStartToLabel = $('.time-range-slider-start-to-label');
    var timeRangeSliderStartFromLabel = $('.time-range-slider-start-from-label');
    var timeRangeSliderEndToLabel = $('.time-range-slider-end-to-label');
    var timeRangeSliderEndFromLabel = $('.time-range-slider-end-from-label');


    var durationSliderStartLabel = $('.duration-slider-start-label');


    var durationSliderEndLabel = $('.duration-slider-end-label');

    var availabilityTimeRangeSlider = $(' .time-range-slider')[0];
    var priceRangeSlider = $('.price-range-slider')[0];
    var hourRangeSliderTo = $('.hour-range-to-slider')[0];
    var hourRangeSliderFrom = $('.hour-range-from-slider')[0];


    var durationSliderStart = $('.duration-start-slider')[0];
    var durationSliderEnd = $('.duration-end-slider')[0];

    noUiSlider.create(priceRangeSlider, {
        start: [ 100, 500 ],
        range: {
            'min': 0,
            'max': 1000
        },
            margin: 1,
            step: 1,
            connect: true,
            pips: {
            mode: 'count',
            values: 1,
            density: 4
        }
    });

    priceRangeSlider.noUiSlider.on('update', function(values, handle) {
        priceRangeSliderStartLabel.text('$' + values[0]);
        priceRangeSliderEndLabel.text('$' + values[1]);
    });

    noUiSlider.create(hourRangeSliderTo, {
        start: [ new Date(2000, 0, 1, 9, 0, 0, 0).getTime(), new Date(2000, 0, 1, 18, 0, 0, 0).getTime() ],
        range: {
            'min': new Date(2000, 0, 1, 0, 0, 0, 0).getTime(),
            'max': new Date(2000, 0, 2, 0, 0, 0, 0).getTime()
        },
        margin: 5 * 60 * 1000,
        step: 1 * 60 * 1000,
        connect: true,

        pips: {
            mode: 'count',
            values: 1,
            density: 4
        }

    });

    noUiSlider.create(hourRangeSliderFrom, {
        start: [ new Date(2000, 0, 1, 9, 0, 0, 0).getTime(), new Date(2000, 0, 1, 18, 0, 0, 0).getTime() ],
        range: {
            'min': new Date(2000, 0, 1, 0, 0, 0, 0).getTime(),
            'max': new Date(2000, 0, 2, 0, 0, 0, 0).getTime()
        },
        margin: 5 * 60 * 1000,
        step: 1 * 60 * 1000,
        connect: true,

        pips: {
            mode: 'count',
            values: 1,
            density: 4
        }

    });

    hourRangeSliderTo.noUiSlider.on('update', function(values, handle) {
        var dateToFormatStart = new Date(+values[0]);
        var dateToFormatEnd = new Date(+values[1]);
        var dateFormattedStart = ('00' + dateToFormatStart.getHours()).slice(-2) + ':' + ('00' + dateToFormatStart.getMinutes()).slice(-2);
        var dateFormattedEnd = ('00' + dateToFormatEnd.getHours()).slice(-2) + ':' + ('00' + dateToFormatEnd.getMinutes()).slice(-2);
        timeRangeSliderStartToLabel.text(dateFormattedStart + ' hs');
        timeRangeSliderEndToLabel.text((dateFormattedEnd === '00:00'? '24:00' : dateFormattedEnd) + ' hs');
    });

    hourRangeSliderFrom.noUiSlider.on('update', function(values, handle) {
        var dateToFormatStart = new Date(+values[0]);
        var dateToFormatEnd = new Date(+values[1]);
        var dateFormattedStart = ('00' + dateToFormatStart.getHours()).slice(-2) + ':' + ('00' + dateToFormatStart.getMinutes()).slice(-2);
        var dateFormattedEnd = ('00' + dateToFormatEnd.getHours()).slice(-2) + ':' + ('00' + dateToFormatEnd.getMinutes()).slice(-2);
        timeRangeSliderStartFromLabel.text(dateFormattedStart + ' hs');
        timeRangeSliderEndFromLabel.text((dateFormattedEnd === '00:00'? '24:00' : dateFormattedEnd) + ' hs');
    });


    noUiSlider.create(durationSliderStart, {
        start: 150,
        range: {
        'min': 100,
        'max': 300
        },
        step: 1,
        connect: 'lower',
        pips: {
        mode: 'steps',
        density: 10
        }
    });


    noUiSlider.create(durationSliderEnd, {
        start: 150,
        range: {
            'min': 100,
            'max': 300
        },
        step: 1,
        connect: 'lower',
        pips: {
            mode: 'steps',
            density: 10
        }
    });

    durationSliderStart.noUiSlider.on('update', function(values, handle) {
        var currentMinutesDuration = (values[handle] | 0);
        durationSliderStartLabel.text(currentMinutesDuration);
    });


    durationSliderEnd.noUiSlider.on('update', function(values, handle) {
        var currentMinutesDuration = (values[handle] | 0);
        durationSliderEndLabel.text(currentMinutesDuration);
    });


    $('.box-active-filter .icon-close-filter').click(function(){
        deleteActiveFilter($(this).parent());
    });



    $('.body-filter .checkbox').click(function(){

        $("input[type=checkbox]").change(function(){

            $(this).parent().parent().find('.box-number').removeClass('selected-box');

            if($(this).prop("checked")){
                $(this).parent().parent().find('.box-number').addClass('selected-box');
            }
        });

    });



    $('.box-filter .header-filter').click(function() {

        if($(this).find('h3 i').hasClass('arrow-down')){
            $('.header-filter h3 i').addClass('arrow-down');
            $('.header-filter h3 i').removeClass('arrow-up');
            $(this).find('h3 i').removeClass('arrow-down');
            $(this).find('h3 i').addClass('arrow-up');


            $('.body-filter').slideUp( "slow" );

            $(this).find('.body-filter').slideDown( "slow" );

            $(this).parent().find('.body-filter').slideDown( "slow" );
        } else {
            $('.header-filter h3 i').addClass('arrow-down');
            $('.header-filter h3 i').removeClass('arrow-up');
            $('.body-filter').slideUp( "slow" );
        }

    });

}
#{/set}